generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
///==> note: add onDelete: Cascade for each relation
/// ===== Enums used across schema =====
enum Role {
  ADMIN
  USER
  CC
}

enum InternalRole {
  SOC
  PENTEST
  DFIR
  BLUE_TEAM
  RED_TEAM
  STUDENT
}

enum BadgeType {
  COURSE_COMPLETION
  LAB_SOLVED
  CHALLENGE_SOLVE
  STREAK
  COMMUNITY
  CONTRIBUTION
  CUSTOM
}

enum AchievementCategory {
  LEARNING
  CHALLENGE
  COMMUNITY
  COMPETITION
  MILESTONE
  CUSTOM
}

enum XPSource {
  COURSE
  LAB
  CHALLENGE
  QUIZ
  MANUAL
  LOGIN_BONUS
  SUBSCRIPTION_BONUS
  CUSTOM
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum TrackDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum AssessmentType {
  QUIZ
  EXAM
  PRACTICAL
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum SocialPlatform {
  GITHUB
  LINKEDIN
  TWITTER
  YOUTUBE
  FACEBOOK
  PORTFOLIO
  Email
  OTHER
}

enum SubscriptionDuration {
  MONTHLY
  YEARLY
}

/// ===== Core User model =====
model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name             String            @unique
  email            String            @unique
  password         String
  bio              String?
  address          String?
  birthday         DateTime? 
  phoneNum         String?

  isVerified       Boolean           @default(false) @map("is_verified")
  token            String?
  validationNumber ValidationNumber?
  oauthAccounts    OAuthAccount[]         // relation to multiple external providers

  File             File[]
  image            Image?

  role             Role              @default(USER)
  internalRole     InternalRole?     @default(STUDENT)

  // Relations:
  // info details
  socialLinks         SocialLink[]
  education           Education[]
  skills              UserSkill[]
  certifications      Certification[]

  //from site
  achievements        UserAchievement[]
  badges              UserBadge[]
  careerPaths         UserCareerPath[]

  // progress relations 
  trackProgress       UserTrackProgress[]
  courseProgress      UserCourseProgress[]
  labProgress         UserLabProgress[]
  challengeSolves     UserChallengeSolve[]
  // activity & stats
  dayActivity         UserActivity[]
  // security & logs
  security            UserSecurity?
  securityLogs        SecurityLog[]
  // subscriptions / billing
  subscriptions       Subscription[]
  // points / xp
  points              UserPoints?
  pointsHistory       PointsHistory[]
  // admin/analytics
  stats            UserStats?
  // notifications
  notifications       Notification[]
  xplogs              XPLog[]
  pointsLogs          PointsLog[]
  leaderboardEntries  LeaderboardEntry[]
  userRewards         UserReward[]
  courseRegistrations CourseRegistration[]
  @@map("users")
}

/// ===== Simple auxiliary models =====
model File {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  name      String
  path      String
  url       String
  filename  String?
  mimeType  String      // original is mimetype  
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 

}

model Image {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  name      String
  mimeType  String
  alt       String?
  url       String   @default("placeholder.png")   // original is path      
  userId              String @unique 
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ValidationNumber {
  id         String @id @default(uuid())
  number     String
  isVerified Boolean  @default(false) @map("is_verified") 
  createdAt  DateTime @default(now())
  expiration BigInt
  used       Boolean  @default(false)
  userId     String   @unique
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OAuthAccount {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  provider     String
  providerId   String
  accessToken  String?
  refreshToken String?
  createdAt    DateTime @default(now())

  @@unique([provider, providerId])
}

model Notification {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  type      String
  title     String
  body      String?
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

/// ===== Gamification: Badges / Achievements / XP / Points / Leaderboards =====
model Badge {
  id           String    @id @default(uuid())
  code         String    @unique
  title        String
  description  String?
  iconUrl      String?
  type         BadgeType @default(COURSE_COMPLETION)
  xpReward     Int       @default(0)
  pointsReward Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id      String @id @default(uuid())
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  badge   Badge  @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId String

  awardedAt DateTime @default(now())
  awardedBy String?
  context   String? // e.g., "track:uuid", "lab:uuid", "challenge:uuid"
  meta      Json?

  @@unique([userId, badgeId, context])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model Achievement {
  id           String              @id @default(uuid())
  code         String              @unique
  title        String
  description  String?
  category     AchievementCategory @default(LEARNING)
  xpReward     Int                 @default(0)
  pointsReward Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  achievementId String

  progress   Float?
  achievedAt DateTime?
  awardedBy  String?
  context    String?
  meta       Json?

  @@index([userId])
  @@map("user_achievements")
}

model XPLog {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 userId              String @unique 
  source    XPSource
  amount    Int
  reason    String?
  context   String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("xp_logs")
}

model PointsLog {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   userId              String @unique 
  amount    Int
  reason    String?
  context   String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("points_logs")
}

model Level {
  id        Int      @id
  level     Int      @unique
  xpNeeded  Int
  createdAt DateTime @default(now())

  @@map("levels")
}

model Leaderboard {
  id          String            @id @default(uuid())
  period      LeaderboardPeriod
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime          @default(now())

  entries LeaderboardEntry[]

  @@index([period, periodStart, periodEnd])
  @@map("leaderboards")
}

model LeaderboardEntry {
  id            String      @id @default(uuid())
  leaderboard   Leaderboard @relation(fields: [leaderboardId], references: [id], onDelete: Cascade)
  leaderboardId String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  rank          Int
  score         Int
  extra         Json?
  createdAt     DateTime    @default(now())

  @@index([leaderboardId])
  @@index([userId])
  @@map("leaderboard_entries")
}

model UserActivity {
  id               String   @id @default(uuid())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 userId              String @unique 
  date             DateTime
  activeMinutes    Int      @default(0)
  completedTasks   Int      @default(0)
  labsSolved       Int      @default(0)
  challengesSolved Int      @default(0)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("user_activities")
}

model Reward {
  id          String   @id @default(uuid())
  code        String   @unique
  title       String
  description String?
  costPoints  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  redemptions UserReward[]

  @@map("rewards")
}

model UserReward {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  reward     Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  rewardId   String
  redeemedAt DateTime @default(now())
  meta       Json?

  @@index([userId])
  @@map("user_rewards")
}

/// ===== Progress System: Tracks / Courses / Labs / Challenges + Progress =====
model Track {
  id          String          @id @default(uuid())
  title       String
  description String?
  iconUrl     String?
  difficulty  TrackDifficulty @default(BEGINNER)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  courses       Course[]
  labs          Lab[]
  challenges    Challenge[]
  usersProgress UserTrackProgress[]

  @@map("tracks")
}

model Course {
  id          String          @id @default(uuid())
  track       Track?          @relation(fields: [trackId], references: [id], onDelete: SetNull)
  trackId     String?
  title       String
  description String?
  thumbnail   String?
  difficulty  TrackDifficulty @default(BEGINNER)

  labs          Lab[]
  challenges    Challenge[]
  usersProgress UserCourseProgress[]

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  assessments   Assessment[]
  image         String?
  link          String?
  state         String
  topics        String[]
  favorite      Boolean              @default(false)
  category      String
  myCourses     Boolean
  registrations CourseRegistration[]

  @@map("courses")
}

model CourseRegistration {
  id        String   @id @default(uuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  userId              String @unique 
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Lab {
  id       String  @id @default(uuid())
  track    Track?  @relation(fields: [trackId], references: [id], onDelete: SetNull)
  trackId  String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  courseId String?

  title            String
  description      String?
  difficulty       TrackDifficulty @default(BEGINNER)
  estimatedMinutes Int?
  steps            Json?
  flags            Json?

  usersProgress UserLabProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("labs")
}

model Challenge {
  id       String  @id @default(uuid())
  track    Track?  @relation(fields: [trackId], references: [id], onDelete: SetNull)
  trackId  String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  courseId String?

  title       String
  description String?
  difficulty  TrackDifficulty @default(INTERMEDIATE)
  score       Int             @default(50)
  flag        String?

  usersProgress UserChallengeSolve[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("challenges")
}

model UserTrackProgress {
  id      String @id @default(uuid())
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  track   Track  @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackId String

  progress         Float     @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  labsCompleted    Int       @default(0)
  coursesCompleted Int       @default(0)
  challengesSolved Int       @default(0)
  lastAccess       DateTime?

  @@unique([userId, trackId])
  @@map("user_track_progress")
}

model UserCourseProgress {
  id       String @id @default(uuid())
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId String

  progress    Float     @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  lastAccess  DateTime?

  @@unique([userId, courseId])
  @@map("user_course_progress")
}

model UserLabProgress {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  lab    Lab    @relation(fields: [labId], references: [id], onDelete: Cascade)
  labId  String

  progress    Float     @default(0)
  attempts    Int       @default(0)
  hintsUsed   Int       @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  lastAccess  DateTime?
  context     Json?

  @@unique([userId, labId])
  @@map("user_lab_progress")
}

model UserChallengeSolve {
  id          String    @id @default(uuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  challengeId String

  isSolved    Boolean   @default(false)
  attempts    Int       @default(0)
  solvedAt    DateTime?
  lastAttempt DateTime?

  @@unique([userId, challengeId])
  @@map("user_challenge_solves")
}

model Assessment {
  id        String         @id @default(uuid())
  course    Course?        @relation(fields: [courseId], references: [id], onDelete: SetNull)
  courseId  String?
  title     String
  type      AssessmentType @default(QUIZ)
  questions Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// ===== Skills / Education / Social / Certifications / Career Paths =====
model Skill {
  id    String      @id @default(uuid())
  name  String      @unique
  users UserSkill[]
}

model UserSkill {
  id        String     @id @default(uuid())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
 userId              String @unique 
  skill     Skill      @relation(fields: [skillId], references: [id])
  skillId   String
  level     SkillLevel @default(BEGINNER)
  progress  Int        @default(0)
  updatedAt DateTime   @updatedAt
}

model Education {
  id          String @id @default(uuid())
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  institution String
  degree      String
  field       String
  startYear   Int
  endYear     Int?
}

model SocialLink {
  id     String         @id @default(uuid())
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  type   SocialPlatform
  url    String
}

model Certification {
  id            String    @id @default(uuid())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  title         String
  issuer        String
  issueDate     DateTime
  expireDate    DateTime?
  credentialId  String?
  credentialUrl String?
}

model CareerPath {
  id    String           @id @default(uuid())
  name  String           @unique
  users UserCareerPath[]
}

model UserCareerPath {
  id           String     @id @default(uuid())
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  careerPath   CareerPath @relation(fields: [careerPathId], references: [id])
  careerPathId String
  progress     Int        @default(0)
  startedAt    DateTime   @default(now())
  completedAt  DateTime?
}

/// ===== Security & Monitoring =====
model SecurityLog {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  ip        String?
  userAgent String?
  success   Boolean
  createdAt DateTime @default(now())
}

model UserSecurity {
  id               String    @id @default(uuid())
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String    @unique 
  lastLogin        DateTime?
  loginAttempts    Int       @default(0)
  isSuspended      Boolean   @default(false)
  suspensionReason String?
  twoFactorEnabled Boolean   @default(false)
}

/// ===== Points / Subscriptions / Stats =====
model UserPoints {
  id          String @id @default(uuid())
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String @unique 
  totalPoints Int    @default(0)
  level       Int    @default(1)
}

model PointsHistory {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  points    Int
  reason    String?
  createdAt DateTime @default(now())
}

model SubscriptionPlan {
  id            String               @id @default(uuid())
  name          String               @unique
  price         Float
  duration      SubscriptionDuration
  features      String[]
  subscriptions Subscription[]
}

model Subscription {
  id        String           @id @default(uuid())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
 userId              String @unique 
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
  planId    String
  startDate DateTime         @default(now())
  endDate   DateTime
  isActive  Boolean          @default(true)
}

model UserStats {
  id                  String @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String @unique 
  totalHours          Int    @default(0)
  activeDays          Int    @default(0)
  completedLabs       Int    @default(0)
  completedCourses    Int    @default(0)
  badgesCount         Int    @default(0)
  certificationsCount Int    @default(0)
  profileCompletion   Int    @default(0)
}







/// labs

model userForsqlInjection {
  id       String  @id @default(uuid())
  username String? @unique
  password String

  @@map("userForSQLInjection")
}

model userForXSS {
  id    String @id @default(uuid())
  email String @unique
  posts Post[]
}

model Lab1IDORS {
  id   Int     @id @default(autoincrement())
  path String?
}

model Lab2IDORS {
  id      Int @id @default(1)
  balance Int @default(1000)
}

model Lab3IDORS {
  id      Int    @id @default(autoincrement())
  name    String @default("user")
  balance Int    @default(1000)
}

model Post {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  content   String
  userId              String @unique 
  user      userForXSS @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model lab2sql {
  id       String  @id @default(uuid())
  category String? @default("electronics")
  released String? @default("1")
}

model lab3sql {
  id       String  @id @default(uuid())
  name     String?
  price    String?
  category String? @default("electronics")
}

model ACUser {
  id   Int    @id @default(autoincrement())
  name String
}

model apiHackingLab {
  id       Int                  @id @default(autoincrement())
  username String               @unique
  password String
  image    imageForApiHacking[]
}

model imageForApiHacking {
  id     Int           @id @default(autoincrement())
  name   String
  path   String
  userId Int
  user   apiHackingLab @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProductToPathTraversalLab1 {
  id          Int     @id @default(autoincrement())
  name        String?
  path        String
  description String
}

model BankAccount {
  id             Int    @id @default(autoincrement())
  accountNo      String @unique
  accountPass    String
  accountBalance Float  @default(0)
  accountName    String
}

model CSRFLab2 {
  id        Int    @id @default(autoincrement())
  authority String @unique
  password  String
}

model CSRFLab3 {
  id      Int    @id @default(autoincrement())
  name    String @default("user")
  balance Int    @default(1000)
}

model FileInclusionLab1 {
  id   String @id @default(uuid())
  name String @unique
  path String
}

model CartItem {
  id    Int    @id @default(autoincrement())
  name  String
  price Int
}

model BurPSuiteLab3 {
  id          String  @id @default(uuid())
  name        String?
  path        String?
  description String?
}

model Lab1RaceCondition {
  id      String @id @default(uuid())
  email   String
  name    String
  surname String
  tel     String
}

model Lab1captcha {
  id      String  @id @default(uuid())
  comment String?
  captcha String  @unique
}

model Lab2captcha {
  id      String  @id @default(uuid())
  comment String?
  captcha String?
}

model Lab2captchaComment {
  id      String  @id @default(uuid())
  comment String?
}

model BLVulnUser {
  id        Int              @id @default(autoincrement())
  email     String           @unique
  name      String?
  password  String           @default("") // New field with a default value
  balance   Float            @default(0)
  cartItems BLVulnCartItem[]
}

model BLVulnCartItem {
  id        Int        @id @default(autoincrement())
  productId Int
  quantity  Int
  user      BLVulnUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
}

model Lab3captchaComment {
  id      String  @id @default(uuid())
  comment String?
}

model lab1SSTI1 {
  id      String  @id @default(uuid())
  name    String?
  comment String?
}

model lab1jwt {
  id       String  @id @default(uuid(7))
  username String  @unique
  email    String? @unique
  password String
  token    String?
}

model lab2jwt {
  id       String  @id @default(uuid(7))
  username String  @unique
  email    String? @unique
  password String
  token    String?
}

model lab3jwt {
  id       String  @id @default(uuid(7))
  username String  @unique
  email    String? @unique
  password String
  token    String?
}

model lab2RaceConditionCoupon {
  id       Int                        @id @default(autoincrement())
  coupon   String?                    @unique
  discount Int?                       @default(50)
  isValid  Boolean                    @default(true)
  payments lab2RaceConditionPayment[] @relation("CouponPayments")
}

model lab2RaceConditionPayment {
  id                 Int                      @id @default(autoincrement())
  price              Int
  priceAfterDiscount Int?
  createdAt          DateTime                 @default(now())
  couponId           Int?
  coupon             lab2RaceConditionCoupon? @relation(fields: [couponId], references: [id], name: "CouponPayments")
}

model lab1SSRF {
  id       String @id @default(uuid())
  username String @unique
}

model ClickJackLab1 {
  id       Int     @id @default(autoincrement())
  username String  @unique
  password String
  email    String?
}

model contactUs {
  id        String   @id @default(uuid())
  fname     String
  lname     String
  phone     String
  email     String
  message   String
  createdAt DateTime @default(now())
}
